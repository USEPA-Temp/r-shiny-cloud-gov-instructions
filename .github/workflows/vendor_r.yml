on:
  workflow_dispatch:

jobs:
  download_and_vendor_dependencies:
    runs-on: ubuntu-18.04
    name: Compile and vendor R dependencies for cloud.gov
    # container:
    #   image: cloudfoundry/cflinuxfs3
  
    steps:
    # - name: Install Git
    #   run: |
    #     apt-get -y update
    #     apt-get install -y software-properties-common git

    - uses: actions/checkout@v3

    - name: Install libcurl
      run: |
        sudo apt-get update -y 
        sudo apt-get install -y libcurl4-openssl-dev
        sudo bash .github/scripts/install_geospatial.sh

    - name: Setup Git
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com

    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: 4.2.2

    - name: Download dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        packages: |
          stringr

    - name: List R dependencies
      run: |
        sed -n -e 's/^.*- name: //p' r.yml | tr -d '\015' | sed -n -e 'H;${x;s/\n/,/g;s/^,//;p;}' | xargs echo packs= >> $GITHUB_ENV

    - name: Download R packages except sf
      run: |
        if [ -d "vendor_r" ]; then rm -fr vendor_r; fi
        Rscript .github/scripts/download_packages.R vendor_r/src/contrib ${{ env.packs }} >> $GITHUB_ENV

    - name: Download dependencies for sf
      if: ${{ env.has_sf }}
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        packages: |
          devtools
          sf

    - name: Build sf package binary
      if: ${{ env.has_sf }}
      run: |
        ./github/scripts/install_geospatial
        Rscript .github/scripts/build_sf.R
        cd vendor_r/src/contrib
        find -name 'sf_*' -print0 | sed -ze "p;s/\_R_x86_64-pc-linux-gnu//" | xargs -0 -n2 mv
        cd ../../..

    - name: Run lib_tar.sh to extract each of the libraries needed by sf
      if: ${{ env.has_sf }}
      run: |
        if [ -d "r-lib" ]; then rm -fr r-lib; fi
        mkdir r-lib
        chmod +x .github/scripts/lib_tar.sh
        for L in $LIBS
        do
          find / -iname $L 2>/dev/null | xargs -I {} .github/scripts/lib_tar.sh {}
        done
        .github/scripts/lib_tar.sh /usr/share/gdal
        git add r-lib
        cp .github/scripts/extract_libraries.sh extract_libraries.sh
        git add extract_libraries.sh
      env:
        LIBS: libgdal.so.20 libgeos_c.so libgeos-3.6.2.so libnlopt.so.0 libproj.so.12 libudunits2.so.0 proj.db

    - name: Write package descriptions
      run: |
        Rscript .github/scripts/write_descriptions.R 

    - name: Commit & Push
      if: ${{ success() }}
      run: |
        git add vendor_r
        git commit -m "Automated workflow from GitHub Actions to vendor R dependencies"
        git push
